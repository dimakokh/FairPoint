<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kitchen Board — Показ заказов</title>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<style>
  :root{
    --bg:#ffffff; /* светлая тема */
    --card:#f9f9f9;
    --muted:#555;
    --accent:#7B1F24;
    --accent-light:#B94A4F;
    --accent-soft:#9B3A66;
    --ready:#4CAF50; /* зелёный для готовых */
    --glass: rgba(0,0,0,0.03);
    --shadow: 0 6px 18px rgba(0,0,0,0.1);
    font-family: Inter, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }

  html,body{
    height:100%;
    margin:0;
    background: #fff;
    color: #000;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  .container{
    max-width:1200px;
    margin:28px auto;
    padding:20px;
  }

  header{
    display:flex;
    align-items:center;
    gap:16px;
    margin-bottom:18px;
  }

  .logo{
    width:56px;height:56px;border-radius:12px;
    background: linear-gradient(135deg,var(--accent) 0%, var(--accent-soft) 60%);
    box-shadow: 0 6px 18px rgba(0,0,0,0.2);
    display:flex;align-items:center;justify-content:center;font-weight:700;
    font-size:20px; cursor:pointer;
  }

  h1{ font-size:20px; margin:0; letter-spacing:0.6px;}
  p.lead{ margin:0;color:var(--muted); font-size:13px }

  .board{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:18px;
    margin-top:18px;
  }

  .column{
    background: var(--card);
    border-radius:14px; padding:14px; box-shadow:var(--shadow);
    min-height:300px;
    border: 1px solid rgba(0,0,0,0.1);
  }

  .col-title{
    display:flex;align-items:center;gap:10px;margin-bottom:12px;
  }
  .col-title h2{ margin:0;font-size:16px; }
  .col-count{
    margin-left:auto; font-weight:700; background:rgba(0,0,0,0.05);
    padding:6px 10px;border-radius:10px;font-size:13px;
  }

  .list { display:flex; flex-direction:column; gap:12px; }

  .card{
    display:flex; gap:12px; align-items:center;
    padding:12px;border-radius:12px;background: #fff;
    border: 1px solid rgba(0,0,0,0.1);
    transition: transform .18s ease, box-shadow .18s ease, opacity .3s ease;
  }
  .card:hover{ transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.1) }

  .status-dot{ width:12px;height:12px;border-radius:50%;flex:0 0 12px; }
  .dot-cooking{ background: linear-gradient(180deg,var(--accent-light),var(--accent)); }
  .dot-ready{ background: linear-gradient(180deg,var(--ready),#80e27e); }

  .card-left{ display:flex; gap:12px; align-items:center; width:100%; }
  .order-number{
    min-width:92px;padding:8px 10px;border-radius:8px;font-weight:700;
    background: rgba(0,0,0,0.05);
    text-align:center; font-size:18px;
    color: #000;
  }
  .details{ flex:1; }
  .details .title{ font-size:16px; margin-bottom:6px; color:#000; }
  .details .meta{ font-size:13px; color:var(--muted); }

  .card-actions{ display:flex; gap:8px; align-items:center; }
  .small-btn{ padding:6px 8px;border-radius:8px;border:0; background:rgba(0,0,0,0.05); color:var(--muted); cursor:pointer }
  .small-btn.strong{ background: linear-gradient(90deg,var(--accent-light),var(--accent)); color:#fff; font-weight:600 }

  .card.ready{ border-left:4px solid var(--ready); box-shadow: 0 8px 20px rgba(0,128,0,0.12) }

  @media (max-width:900px){
    .board{ grid-template-columns: 1fr; }
  }

  /* Персональное меню скрыто по умолчанию */
  #personalMenu{
    display:none;
    position: fixed;
    top: 20px; right: 20px;
    width: 300px; background: #fff; border: 1px solid #ccc;
    border-radius: 12px; padding: 12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.2);
    z-index: 999;
  }
  #personalMenu h3{ margin-top:0; font-size:16px; }
  #personalMenu ul{ padding-left:20px; }
  #personalMenu li{ margin-bottom:6px; cursor:pointer; }
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo" id="logo">KB</div>
      <div>
        <h1>Kitchen Board — Показ заказов</h1>
        <p class="lead">Две колонки: <strong>Готовится</strong> и <strong>Готово</strong>.</p>
      </div>
    </header>

    <div class="board">
      <section class="column" id="colCooking">
        <div class="col-title">
          <h2>Готовится</h2>
          <div class="col-count" id="countCooking">0</div>
        </div>
        <div class="list" id="listCooking"></div>
      </section>

      <section class="column" id="colReady">
        <div class="col-title">
          <h2>Готово</h2>
          <div class="col-count" id="countReady">0</div>
        </div>
        <div class="list" id="listReady"></div>
      </section>
    </div>
  </div>

  <div id="personalMenu">
    <h3>Персональное меню</h3>
    <input type="text" id="terminalInput" placeholder="ID терминала" />
    <button id="addTerminalBtn">Добавить терминал</button>
    <ul id="terminalList"></ul>
  </div>

<script>
const AUTO_EXPIRE_MS = 2*60*1000;
let orders = new Map();
let timersExpire = new Map();

// UI refs
const listCooking = document.getElementById('listCooking');
const listReady = document.getElementById('listReady');
const countCooking = document.getElementById('countCooking');
const countReady = document.getElementById('countReady');

// Персональное меню
const logo = document.getElementById('logo');
const personalMenu = document.getElementById('personalMenu');
const terminalInput = document.getElementById('terminalInput');
const addTerminalBtn = document.getElementById('addTerminalBtn');
const terminalList = document.getElementById('terminalList');

let clickCount = 0;
let clickTimer = null;

// Сохранение привязанных терминалов через localStorage
let myTerminals = JSON.parse(localStorage.getItem('myTerminals') || '[]');

function saveTerminals(){
  localStorage.setItem('myTerminals', JSON.stringify(myTerminals));
}

// отображение списка терминалов
function refreshTerminalsUI(){
  terminalList.innerHTML = '';
  myTerminals.forEach(t=>{
    const li = document.createElement('li');
    li.textContent = t + ' ✖';
    li.onclick = ()=> { myTerminals = myTerminals.filter(x=>x!==t); saveTerminals(); refreshTerminalsUI(); refreshUI(); };
    terminalList.appendChild(li);
  });
}

// открыть персональное меню по тройному клику
logo.addEventListener('click', ()=>{
  clickCount++;
  if(clickTimer) clearTimeout(clickTimer);
  clickTimer = setTimeout(()=> clickCount=0, 600);
  if(clickCount>=3){
    personalMenu.style.display = personalMenu.style.display==='none'?'block':'none';
    refreshTerminalsUI();
    clickCount=0;
  }
});

// добавить терминал
addTerminalBtn.addEventListener('click', ()=>{
  const val = terminalInput.value.trim();
  if(val && !myTerminals.includes(val)){
    myTerminals.push(val);
    saveTerminals();
    refreshTerminalsUI();
    terminalInput.value='';
  }
});

// Firebase
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCSw_6Lv22XH-jwK3NN6B6QHH_UCa6Sn1s",
  authDomain: "fairpay-fast.firebaseapp.com",
  databaseURL: "https://fairpay-fast-default-rtdb.firebaseio.com",
  projectId: "fairpay-fast",
  storageBucket: "fairpay-fast.firebasestorage.app",
  messagingSenderId: "764987626490",
  appId: "1:764987626490:web:e3451c8162f6992449ca43"
};

let dbRef=null;
let firebaseEnabled=false;

try{
  firebase.initializeApp(FIREBASE_CONFIG);
  const db = firebase.database();
  dbRef = db.ref('orders');
  firebaseEnabled = true;
  console.info('Firebase enabled');
}catch(e){ console.warn('Firebase init failed', e); }

// helpers
function el(tag, cls, inner){
  const d = document.createElement(tag);
  if(cls) d.className=cls;
  if(inner!==undefined) d.innerHTML=inner;
  return d;
}
function formatTime(ts){ return new Date(ts).toLocaleTimeString(); }

function renderOrderCard(key, order){
  const c = el('div','card');
  c.dataset.key = key;
  if(order.status==='completed' || order.status==='ready') c.classList.add('ready');

  const left = el('div','card-left');
  const dot = el('div','status-dot '+(order.status==='completed'?'dot-ready':'dot-cooking'));
  const num = el('div','order-number', `<div style="font-size:12px;color:var(--muted)">#</div>${order.orderNumber||key}`);
  const details = el('div','details');
  const title = el('div','title', `${order.items&&order.items.length?order.items.map(i=>i.name).join(', '):'Заказ'}`);
  const meta = el('div','meta', `Терминал: ${order.terminalId||'—'} • ${order.time?formatTime(order.time):''}`);

  details.appendChild(title);
  details.appendChild(meta);
  left.appendChild(dot);
  left.appendChild(num);
  left.appendChild(details);

  const actions = el('div','card-actions');
  if(order.status!=='completed'){
    const btnReady = el('button','small-btn strong','Пометить готовым');
    btnReady.onclick = ()=> markReady(key);
    actions.appendChild(btnReady);
  }

  c.appendChild(left);
  c.appendChild(actions);
  return c;
}

function refreshUI(){
  listCooking.innerHTML=''; listReady.innerHTML='';
  let cookingCount=0, readyCount=0;
  for(const [key, order] of orders.entries()){
    if(!myTerminals.includes(order.terminalId)) continue; // фильтр по терминалам
    if(order.status==='pending' || order.status==='cooking'){
      listCooking.appendChild(renderOrderCard(key, order));
      cookingCount++;
    }else if(order.status === 'completed' || order.status === 'ready' || order.status === 'cooking_done'){
      listReady.appendChild(renderOrderCard(key, order));
      readyCount++;
    }
  }
  countCooking.textContent=cookingCount;
  countReady.textContent=readyCount;
}

function markReady(key){
  const order = orders.get(key);
  if(!order) return;
  order.status='completed';
  order.timeReady = Date.now();
  orders.set(key, order);
  refreshUI();
  handleBecameReady(key, order);
  if(firebaseEnabled && dbRef) dbRef.child(key).update({status:'completed', timeReady:Date.now()}).catch(()=>{});
}

function handleBecameReady(key, order){
  // озвучка
  try{
    const u = new SpeechSynthesisUtterance(`Заказ номер ${order.orderNumber||key} готов`);
    u.lang='ru-RU';
    speechSynthesis.cancel();
    setTimeout(()=> speechSynthesis.speak(u), 200);
  }catch(e){}
  // автоудаление через 2 минуты
  clearExpireTimer(key);
  const t=setTimeout(()=>{
    orders.delete(key);
    refreshUI();
  }, AUTO_EXPIRE_MS);
  timersExpire.set(key,t);
}

function clearExpireTimer(key){ const t=timersExpire.get(key); if(t){clearTimeout(t); timersExpire.delete(key);} }

// Firebase listeners
if(firebaseEnabled && dbRef){
  dbRef.on('child_added', snapshot=>{
    const key=snapshot.key; const val=snapshot.val();
    orders.set(key,val);
    refreshUI();
  });
  dbRef.on('child_changed', snapshot=>{
    const key=snapshot.key; const val=snapshot.val();
    orders.set(key,val);
    refreshUI();
  });
  dbRef.on('child_removed', snapshot=>{
    const key=snapshot.key;
    orders.delete(key);
    clearExpireTimer(key);
    refreshUI();
  });
}
</script>
</body>
</html>
