<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FairPoint — Касса / Кухня (обновлённый)</title>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<style>
  :root{
    --bg:#f4f4f6;
    --card:#ffffff;
    --muted:#666;
    --accent:#ff7a45;
    --accent-dark:#d9480f;
    --cook:#ff5252;
    --packing:#ffb74d;
    --ready:#4caf50;
    --shadow: 0 8px 28px rgba(16,24,40,0.06);
    font-family: Inter, "Segoe UI", Roboto, Arial, sans-serif;
    color-scheme: light;
  }

  html,body{height:100%; margin:0; background:var(--bg); color:#111;}
  .app{max-width:1200px;margin:16px auto;padding:12px;}
  header{display:flex;align-items:center;gap:12px;padding:8px 0;}
  #logo{
    width:64px;height:64px;border-radius:12px;
    background:linear-gradient(135deg,var(--accent),var(--accent-dark));
    display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:18px; cursor:pointer;
    user-select:none;
  }
  #brand{font-size:18px;font-weight:800}
  .role-select{margin-left:auto; display:flex; gap:8px;}
  .role-btn{padding:10px 14px;border-radius:8px;border:1px solid rgba(0,0,0,0.06); background:#fff; cursor:pointer;}
  .role-btn.active{box-shadow:var(--shadow); outline:2px solid rgba(0,0,0,0.04);}

  main{margin-top:12px;}

  /* layout */
  .layout{display:grid; grid-template-columns: 1fr 380px; gap:12px;}
  .panel{background:var(--card); border-radius:12px; padding:12px; box-shadow:var(--shadow);}

  /* cashier layout */
  .tabs{display:flex; gap:8px; margin-bottom:12px;}
  .tab{padding:8px 10px;border-radius:8px;background:#fafafa; cursor:pointer; border:1px solid #eee;}
  .tab.active{background:#fff; box-shadow:var(--shadow);}

  .list{display:flex;flex-direction:column;gap:10px; max-height:66vh; overflow:auto;padding:6px;}
  .order-row{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;border:1px solid #eee;background:#fff;}
  .order-left{display:flex;gap:12px;align-items:center;}
  .badge{padding:6px 8px;border-radius:8px;font-weight:800;color:#fff}
  .code{background:linear-gradient(90deg,var(--accent),var(--accent-dark));}
  .meta{color:var(--muted);font-size:13px}
  .btn{padding:8px 10px;border-radius:8px;border:none;cursor:pointer;background:var(--accent);color:#fff;font-weight:700}
  .btn.gray{background:#f0f0f0;color:#111;border:1px solid #e6e6e6}
  .btn.red{background:#ff4d4f}

  /* kitchen minimal UI */
  .kitchen-root{display:flex;flex-direction:column;gap:12px;height:76vh;}
  .kitchen-top{display:flex;align-items:center;gap:12px}
  .bind-btn{padding:8px 12px;border-radius:8px;border:1px solid #e6e6e6;background:#fff;cursor:pointer}
  .kitchen-full-list{flex:1;overflow:auto;display:flex;flex-direction:column;gap:10px;padding:6px}
  .cooking-card{
    background:#fff;border-radius:12px;padding:18px;border:1px solid #eee;
    display:flex;flex-direction:column;gap:8px;box-shadow:var(--shadow);min-height:120px;
  }
  .cooking-card .num{font-size:36px;font-weight:900;letter-spacing:3px}
  .items-list{display:flex;flex-direction:column;gap:6px}
  .item-row{display:flex;justify-content:space-between;align-items:center;padding:6px;border-radius:8px;background:transparent}
  .total-row{display:flex;justify-content:space-between;align-items:center;padding-top:8px;border-top:1px dashed #eee;font-weight:800}

  /* ready small */
  .ready-list{display:flex;gap:8px;flex-wrap:wrap}
  .ready-tile{background:#fff;padding:10px 12px;border-radius:10px;border:1px solid #eee;cursor:pointer;display:flex;align-items:center;gap:8px}
  .ready-tile .num{font-weight:900}

  /* modal */
  .modal-back{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:9999}
  .modal{width:520px;background:#fff;border-radius:12px;padding:16px;box-shadow:0 18px 50px rgba(0,0,0,0.4)}
  .modal h4{margin:0 0 8px 0}
  .row{display:flex;justify-content:space-between;gap:8px;margin:8px 0}
  .input{padding:8px;border-radius:8px;border:1px solid #eee;width:100%}

  /* staff menu */
  #staffMenu{position:fixed;right:16px;top:16px;background:#fff;border-radius:10px;padding:12px;box-shadow:var(--shadow);display:none;z-index:999}
  #staffMenu h4{margin:0 0 8px 0}
  #termList div{display:flex;justify-content:space-between;align-items:center;padding:6px 0}

  .muted{color:var(--muted);font-size:13px}
</style>
</head>
<body>
<div class="app">
  <header>
    <div id="logo" title="Три клика — персональное меню">FP</div>
    <div id="brand">FairPoint — Касса / Кухня</div>

    <div class="role-select" id="roleSelect">
      <button class="role-btn" data-role="cashier" id="btnRoleCashier">Кассир</button>
      <button class="role-btn" data-role="kitchen" id="btnRoleKitchen">Кухня</button>
    </div>
  </header>

  <main>
    <div class="layout">
      <div id="mainPanel" class="panel">
        <div id="welcome" class="muted">Выберите роль — Кассир или Кухня. Привяжите терминал в персональном меню (3 клика по логотипу).</div>
      </div>

      <div class="panel" style="min-width:300px">
        <h4>Привязанные терминалы</h4>
        <div id="boundList" class="muted">Нет привязанных терминалов</div>
        <div style="height:12px"></div>
        <h4>Активная роль: <span id="currentRole">—</span></h4>
        <div id="roleInfo" class="muted">Здесь будет информация по выбранной роли</div>
      </div>
    </div>
  </main>
</div>

<!-- Staff menu (triple click logo) -->
<div id="staffMenu">
  <h4>Персональное меню (Staff)</h4>
  <div>
    <label>Добавить терминал (ID):</label>
    <input id="termInput" class="input" placeholder="например 1103" />
    <div style="height:8px"></div>
    <button id="addTermBtn" class="btn gray">Добавить терминал</button>
    <div style="height:12px"></div>
    <div id="termList"></div>
    <div style="height:12px"></div>
    <button id="closeStaff" class="btn gray">Закрыть</button>
  </div>
</div>

<!-- Modal for cashier order -->
<div class="modal-back" id="modal">
  <div class="modal">
    <h4 id="modalTitle">Заявка на наличные</h4>
    <div class="row"><div class="muted">Код:</div><div id="modalCode" style="font-weight:900"></div></div>
    <div class="row"><div class="muted">Терминал:</div><div id="modalTerm" class="muted"></div></div>
    <div class="row"><div class="muted">Сумма:</div><div id="modalAmount" class="muted"></div></div>
    <div class="row"><div class="muted">Время:</div><div id="modalTime" class="muted"></div></div>

    <div style="margin-top:8px">
      <label>Сдача клиенту (если подтверждаешь):</label>
      <input id="changeInput" class="input" placeholder="0.00" />
    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button id="modalReject" class="btn red">Отклонить</button>
      <button id="modalClose" class="btn gray">Закрыть</button>
      <button id="modalConfirm" class="btn">Подтвердить</button>
    </div>
  </div>
</div>

<script>
/* ========== CONFIG: Firebase ========== */
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyABvY_6cHonbLvdBj5cYMSheJDLMd_-bNw",
  authDomain: "app-fairpay.firebaseapp.com",
  databaseURL: "https://app-fairpay-default-rtdb.firebaseio.com",
  projectId: "app-fairpay",
  storageBucket: "app-fairpay.firebasestorage.app",
  messagingSenderId: "29576302334",
  appId: "1:29576302334:web:0e559f804bf62c59981faf"
};

firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.database();
const ordersRef = db.ref('orders');

/* ========== State ========== */
let boundTerminals = JSON.parse(localStorage.getItem('boundTerminals') || '[]'); // array of ids
let currentRole = localStorage.getItem('currentRole') || null; // 'cashier' | 'kitchen'
let orders = new Map(); // key -> order object (latest snapshot)
let autoOpenModal = true; // auto open on new cash order
let tripleClicks = 0;
let tripleTimer = null;

/* announced set for TTS dedupe (in-memory only) */
const announced = new Set();

/* ========== DOM ========== */
const logo = document.getElementById('logo');
const staffMenu = document.getElementById('staffMenu');
const termInput = document.getElementById('termInput');
const addTermBtn = document.getElementById('addTermBtn');
const termList = document.getElementById('termList');
const closeStaff = document.getElementById('closeStaff');

const mainPanel = document.getElementById('mainPanel');
const boundList = document.getElementById('boundList');
const currentRoleLabel = document.getElementById('currentRole');
const roleInfo = document.getElementById('roleInfo');

const btnRoleCashier = document.getElementById('btnRoleCashier');
const btnRoleKitchen = document.getElementById('btnRoleKitchen');

/* Modal elements */
const modalBack = document.getElementById('modal');
const modalCode = document.getElementById('modalCode');
const modalTerm = document.getElementById('modalTerm');
const modalAmount = document.getElementById('modalAmount');
const modalTime = document.getElementById('modalTime');
const changeInput = document.getElementById('changeInput');
const modalConfirm = document.getElementById('modalConfirm');
const modalReject = document.getElementById('modalReject');
const modalClose = document.getElementById('modalClose');

let currentModalKey = null;

/* init UI */
renderBoundList();
setRole(currentRole || null);

/* ======= Staff menu (triple click logo) ======= */
logo.addEventListener('click', ()=> {
  tripleClicks++;
  if(tripleTimer) clearTimeout(tripleTimer);
  tripleTimer = setTimeout(()=> { tripleClicks = 0 }, 500);
  if(tripleClicks >= 3) {
    tripleClicks = 0;
    staffMenu.style.display = (staffMenu.style.display === 'flex' ? 'none' : 'flex');
    renderTermList();
  }
});

addTermBtn.addEventListener('click', ()=> {
  const id = termInput.value.trim();
  if(!id) return alert('Введите ID терминала');
  if(boundTerminals.includes(id)) { termInput.value=''; renderTermList(); return; }
  boundTerminals.push(id);
  localStorage.setItem('boundTerminals', JSON.stringify(boundTerminals));
  termInput.value='';
  renderTermList();
  renderBoundList();
  refreshMain();
});

closeStaff.addEventListener('click', ()=> {
  staffMenu.style.display = 'none';
});

function renderTermList(){
  termList.innerHTML = '';
  if(boundTerminals.length === 0) {
    termList.innerHTML = '<div class="muted">Нет привязанных терминалов</div>';
    return;
  }
  boundTerminals.forEach(t => {
    const row = document.createElement('div');
    row.style.display = 'flex';
    row.style.justifyContent = 'space-between';
    row.style.alignItems = 'center';
    row.style.marginBottom = '6px';
    const span = document.createElement('div'); span.textContent = t;
    const del = document.createElement('button'); del.textContent = 'Удалить'; del.className='btn gray';
    del.addEventListener('click', ()=> {
      boundTerminals = boundTerminals.filter(x=>x!==t);
      localStorage.setItem('boundTerminals', JSON.stringify(boundTerminals));
      renderTermList();
      renderBoundList();
      refreshMain();
    });
    row.appendChild(span);
    row.appendChild(del);
    termList.appendChild(row);
  });
}

function renderBoundList(){
  if(boundTerminals.length === 0){
    boundList.textContent = 'Нет привязанных терминалов';
  } else {
    boundList.textContent = boundTerminals.join(', ');
  }
}

/* ===== Role management ===== */
btnRoleCashier.addEventListener('click', ()=> setRole('cashier'));
btnRoleKitchen.addEventListener('click', ()=> setRole('kitchen'));

function setRole(role){
  currentRole = role;
  localStorage.setItem('currentRole', role || '');
  currentRoleLabel.textContent = role ? (role === 'cashier' ? 'Кассир' : 'Кухня') : '—';
  btnRoleCashier.classList.toggle('active', role === 'cashier');
  btnRoleKitchen.classList.toggle('active', role === 'kitchen');
  renderBoundList();
  refreshMain();
}

/* ===== Main rendering based on role ===== */
function refreshMain(){
  mainPanel.innerHTML = '';
  if(!currentRole){
    mainPanel.innerHTML = '<div class="muted">Выберите роль — Кассир или Кухня. Привяжите терминал в персональном меню (3 клика по логотипу).</div>';
    return;
  }
  if(currentRole === 'cashier'){
    renderCashier();
  } else {
    renderKitchenMinimal();
  }
}

/* ===== Cashier UI ===== */
let currentCashTab = 'orders'; // orders | history
function renderCashier(){
  currentRoleLabel.textContent = 'Кассир';
  mainPanel.innerHTML = `
    <div>
      <div class="tabs">
        <div class="tab ${currentCashTab==='orders'?'active':''}" id="tabOrders">Ожидающие наличные</div>
        <div class="tab ${currentCashTab==='history'?'active':''}" id="tabHistory">История</div>
        <div style="margin-left:auto" class="muted">Терминалы: ${boundTerminals.join(', ')}</div>
      </div>
      <div id="cashierContent"></div>
    </div>
  `;
  document.getElementById('tabOrders').addEventListener('click', ()=> { currentCashTab='orders'; renderCashier(); });
  document.getElementById('tabHistory').addEventListener('click', ()=> { currentCashTab='history'; renderCashier(); });
  const holder = document.getElementById('cashierContent');

  if(currentCashTab === 'orders'){
    holder.innerHTML = `
      <div class="panel" style="margin-bottom:10px">
        <div style="display:flex;gap:8px">
          <div class="search" style="flex:1">
            <input id="searchOrderInput" class="input" placeholder="Поиск по коду (например 0022)" />
            <button id="searchOrderBtn" class="btn gray">Найти</button>
          </div>
          <div>
            <label style="display:block;font-size:13px;color:var(--muted)">Авто-открытие</label>
            <input type="checkbox" id="autoOpenCheckbox" ${autoOpenModal?'checked':''} />
          </div>
        </div>
      </div>
      <div class="panel">
        <div id="ordersList" class="list"></div>
      </div>
    `;
    document.getElementById('autoOpenCheckbox').addEventListener('change', e=> autoOpenModal = e.target.checked);
    document.getElementById('searchOrderBtn').addEventListener('click', ()=> {
      const code = document.getElementById('searchOrderInput').value.trim();
      if(!code) return alert('Введите код');
      for(const [k,o] of orders.entries()){
        if(String(o.orderNumber) === code && o.paymentType === 'cash'){
          if(boundTerminals.includes(o.terminalId)){
            openOrderModal(k, o);
            return;
          } else {
            alert('Заказ найден, но он не от привязанного терминала');
            return;
          }
        }
      }
      alert('Код не найден');
    });
    populateCashOrders();
  } else {
    holder.innerHTML = `
      <div class="panel">
        <h4>История кассира (локально)</h4>
        <div id="historyList" class="history"></div>
      </div>
    `;
    renderHistory();
  }
}

/* ===== Cashier helpers etc. (same as earlier) ===== */
function populateCashOrders(){
  const list = document.getElementById('ordersList');
  if(!list) return;
  list.innerHTML = '';
  const arr = Array.from(orders.entries()).filter(([k,o]) => {
    return o && o.paymentType === 'cash' && o.status === 'waiting_for_cash' && boundTerminals.includes(o.terminalId);
  }).sort((a,b)=> (a[1].time||0) - (b[1].time||0));

  if(arr.length === 0){
    list.innerHTML = '<div class="muted">Нет заявок на наличные от привязанных терминалов</div>';
    return;
  }

  arr.forEach(([k,o])=>{
    const row = document.createElement('div'); row.className='order-row';
    const left = document.createElement('div'); left.className='order-left';
    const code = document.createElement('div'); code.className='badge code'; code.textContent = o.orderNumber || '—';
    const meta = document.createElement('div'); meta.innerHTML = `<div style="font-weight:700">${o.items?.map(i=>i.name).join(', ') || 'Заказ'}</div><div class="muted">${new Date(o.time||Date.now()).toLocaleString()}</div>`;
    left.appendChild(code); left.appendChild(meta);
    const right = document.createElement('div');
    const amount = document.createElement('div'); amount.className='muted'; amount.style.fontWeight='800'; amount.textContent = (o.amount !== undefined ? Number(o.amount).toFixed(2) : '—');
    const openBtn = document.createElement('button'); openBtn.className='btn gray'; openBtn.textContent='Открыть'; openBtn.addEventListener('click', ()=> openOrderModal(k,o));
    right.appendChild(amount); right.appendChild(openBtn);
    row.appendChild(left); row.appendChild(right);
    list.appendChild(row);
  });
}

function openOrderModal(key, order){
  currentModalKey = key;
  modalCode.textContent = order.orderNumber || '—';
  modalTerm.textContent = order.terminalId || '—';
  modalAmount.textContent = (order.amount !== undefined ? Number(order.amount).toFixed(2) : '—');
  modalTime.textContent = new Date(order.time||Date.now()).toLocaleString();
  changeInput.value = '';
  modalBack.style.display = 'flex';
}
modalClose.addEventListener('click', ()=> { modalBack.style.display='none'; currentModalKey = null; });
modalBack.addEventListener('click', (e)=> { if(e.target === modalBack){ modalBack.style.display='none'; currentModalKey = null; } });

modalConfirm.addEventListener('click', ()=> {
  if(!currentModalKey) return;
  const key = currentModalKey;
  const changeVal = parseFloat(changeInput.value) || 0.0;
  const updates = {
    status: 'cooking',
    confirmedBy: 'cashier',
    confirmedAt: Date.now(),
    changeGiven: changeVal
  };
  ordersRef.child(key).update(updates, (err)=>{
    if(err){ alert('Ошибка обновления: '+err.message); return; }
    pushCashierHistory({ action: 'confirm', orderNumber: orders.get(key)?.orderNumber || key, key, changeGiven: changeVal, time: Date.now() });
    modalBack.style.display='none';
    currentModalKey = null;
  });
});

modalReject.addEventListener('click', ()=> {
  if(!currentModalKey) return;
  const key = currentModalKey;
  const updates = {
    rejectedByCashier: true,
    rejectedAt: Date.now()
  };
  ordersRef.child(key).update(updates, (err)=>{
    if(err){ alert('Ошибка отклонения: '+err.message); return; }
    pushCashierHistory({ action: 'reject', orderNumber: orders.get(key)?.orderNumber || key, key, time: Date.now() });
    modalBack.style.display='none';
    currentModalKey = null;
  });
});

function pushCashierHistory(entry){
  const hist = JSON.parse(localStorage.getItem('cashierHistory') || '[]');
  hist.unshift(entry);
  localStorage.setItem('cashierHistory', JSON.stringify(hist.slice(0,200)));
  renderHistory();
}
function renderHistory(){
  const hist = JSON.parse(localStorage.getItem('cashierHistory') || '[]');
  const holder = document.getElementById('historyList');
  if(!holder) return;
  holder.innerHTML = '';
  if(hist.length === 0) holder.innerHTML = '<div class="muted">История пуста</div>';
  hist.forEach(h=>{
    const el = document.createElement('div'); el.className='item';
    el.innerHTML = `<div style="font-weight:800">${h.action === 'confirm' ? 'Подтверждение' : 'Отклонение'} — ${h.orderNumber}</div>
      <div class="muted">${new Date(h.time).toLocaleString()}</div>
      ${h.changeGiven !== undefined ? `<div class="muted">Сдача: ${Number(h.changeGiven).toFixed(2)}</div>` : ''}`;
    holder.appendChild(el);
  });
}

/* ===== Kitchen minimal UI (as requested) =====
   - minimal header: logo, bind button, brand
   - list of cooking orders occupies main space (big cards)
   - ready list small with small tiles and cancel option
   - show order number, items (with counts), and total price if present; hide total if missing
   - no boundTerminals list displayed here (but orders filtered by boundTerminals)
*/
function renderKitchenMinimal(){
  currentRoleLabel.textContent = 'Кухня';
  mainPanel.innerHTML = `
    <div class="kitchen-root">
      <div class="kitchen-top">
        <div style="display:flex;align-items:center;gap:12px">
          <div id="kLogo" style="width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-dark));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;cursor:pointer">FP</div>
          <div style="font-weight:800">FireDome — Кухня</div>
        </div>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <button id="kBindBtn" class="bind-btn">Привязать терминал</button>
          <div class="muted" id="kBoundInfo">${boundTerminals.length ? ('Терминалы: ' + boundTerminals.join(', ')) : 'Нет привязанных терминалов'}</div>
        </div>
      </div>

      <div style="font-size:13px;color:var(--muted)">Список готовящихся заказов. Карточки занимают всё пространство. Нажмите плитку — отметить готовым (или изменить статус).</div>

      <div class="kitchen-full-list" id="kCookingList"></div>

      <div style="margin-top:6px">
        <div style="font-weight:800;margin-bottom:8px">Готово (малые плитки — можно отменить)</div>
        <div class="ready-list" id="kReadyList"></div>
      </div>
    </div>
  `;

  document.getElementById('kBindBtn').addEventListener('click', ()=> {
    const id = prompt('Введи ID терминала для привязки (пример: 1103)');
    if(!id) return;
    if(boundTerminals.includes(id)) {
      alert('Терминал уже привязан');
      return;
    }
    boundTerminals.push(id);
    localStorage.setItem('boundTerminals', JSON.stringify(boundTerminals));
    document.getElementById('kBoundInfo').textContent = 'Терминалы: ' + boundTerminals.join(', ');
    renderBoundList();
    refreshMain();
  });

  populateKitchenMinimal();
}

/* helper to format items summary: "2 × Чизбургер" */
function formatItemsList(items){
  if(!items || !items.length) return [];
  // If items have count property, aggregate by name
  const map = new Map();
  for(const it of items){
    const name = it.name || 'Товар';
    const cnt = Number(it.count || 1);
    const key = name;
    map.set(key, (map.get(key) || 0) + cnt);
  }
  const rows = [];
  for(const [name, cnt] of map.entries()){
    rows.push({ name, count: cnt });
  }
  return rows;
}

/* populate kitchen minimal view */
function populateKitchenMinimal(){
  const cookingHolder = document.getElementById('kCookingList');
  const readyHolder = document.getElementById('kReadyList');
  if(!cookingHolder || !readyHolder) return;

  cookingHolder.innerHTML = '';
  readyHolder.innerHTML = '';

  if(boundTerminals.length === 0){
    cookingHolder.innerHTML = '<div class="muted">Нет привязанных терминалов — привяжи терминал (кнопка "Привязать терминал")</div>';
    return;
  }

  // cooking orders: only status === 'cooking' (explicit)
  const cookingArr = Array.from(orders.entries()).filter(([k,o])=>{
    return o && boundTerminals.includes(o.terminalId) && o.status === 'cooking';
  }).sort((a,b)=> (a[1].time||0) - (b[1].time||0));

  const readyArr = Array.from(orders.entries()).filter(([k,o])=>{
    return o && boundTerminals.includes(o.terminalId) && o.status === 'ready';
  }).sort((a,b)=> (a[1].timeReady||0) - (b[1].timeReady||0));

  // render cooking as big cards that occupy width (stacked)
  if(cookingArr.length === 0){
    cookingHolder.innerHTML = '<div class="muted">Пусто — нет готовящихся заказов</div>';
  } else {
    cookingArr.forEach(([k,o])=>{
      const card = document.createElement('div');
      card.className = 'cooking-card';
      // order number
      const num = document.createElement('div'); num.className = 'num'; num.textContent = o.orderNumber || '—';
      card.appendChild(num);
      // items
      const itemsWrapper = document.createElement('div');
      itemsWrapper.className = 'items-list';
      const rows = formatItemsList(o.items || []);
      if(rows.length === 0){
        const r = document.createElement('div'); r.className = 'item-row muted'; r.textContent = 'Позиции не указаны';
        itemsWrapper.appendChild(r);
      } else {
        rows.forEach(rw=>{
          const r = document.createElement('div'); r.className = 'item-row';
          const left = document.createElement('div'); left.textContent = `${rw.count} × ${rw.name}`;
          itemsWrapper.appendChild(r);
          r.appendChild(left);
        });
      }
      card.appendChild(itemsWrapper);
      // total price if present in order.amount or order.total
      const totalVal = (o.amount !== undefined) ? o.amount : (o.total !== undefined ? o.total : null);
      if(totalVal !== null && !isNaN(Number(totalVal))){
        const tot = document.createElement('div'); tot.className = 'total-row';
        tot.innerHTML = `<div class="muted">Итого</div><div>${Number(totalVal).toFixed(2)}</div>`;
        card.appendChild(tot);
      }
      // actions: click to mark ready (or change)
      const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px'; actions.style.marginTop='8px';
      const btnReady = document.createElement('button'); btnReady.className='btn'; btnReady.textContent='Пометить готовым';
      btnReady.addEventListener('click', ()=> {
        const updates = { status: 'ready', timeReady: Date.now() };
        ordersRef.child(k).update(updates, err=>{
          if(err) return alert('Ошибка: ' + err.message);
          // local update will be processed by listener
        });
      });
      const btnCancel = document.createElement('button'); btnCancel.className='btn gray'; btnCancel.textContent='Отменить';
      btnCancel.addEventListener('click', ()=> {
        if(!confirm('Отменить этот заказ?')) return;
        ordersRef.child(k).update({ status: 'canceled', canceledBy: 'kitchen', canceledAt: Date.now() }, err=>{
          if(err) alert('Ошибка при отмене: '+err.message);
        });
      });
      actions.appendChild(btnReady); actions.appendChild(btnCancel);
      card.appendChild(actions);

      cookingHolder.appendChild(card);
    });
  }

  // ready small tiles — include cancel button on tile or click to cancel
  if(readyArr.length === 0){
    readyHolder.innerHTML = '<div class="muted">Нет готовых заказов</div>';
  } else {
    readyArr.forEach(([k,o])=>{
      const tile = document.createElement('div'); tile.className = 'ready-tile';
      const num = document.createElement('div'); num.className = 'num'; num.textContent = o.orderNumber || '—';
      tile.appendChild(num);
      const btnCancel = document.createElement('button'); btnCancel.className = 'btn gray'; btnCancel.textContent = 'Отменить';
      btnCancel.addEventListener('click', ()=> {
        if(!confirm('Отменить готовый заказ?')) return;
        ordersRef.child(k).update({ status: 'canceled', canceledBy: 'kitchen', canceledAt: Date.now() }, err=>{
          if(err) alert('Ошибка при отмене: '+err.message);
        });
      });
      tile.appendChild(btnCancel);
      readyHolder.appendChild(tile);
    });
  }
}

/* ===== Kitchen cycle (used by other UIs) - keep simple helper, but kitchen uses explicit buttons above ===== */
function cycleKitchenStatus(key, order){
  if(!order) return;
  // simple toggle: cooking -> ready (set timeReady) ; ready -> canceled (or cooking)
  const next = order.status === 'cooking' ? 'ready' : 'cooking';
  const updates = { status: next };
  if(next === 'ready') updates.timeReady = Date.now();
  ordersRef.child(key).update(updates, err=>{
    if(err) return alert('Ошибка смены статуса: '+err.message);
  });
}

/* ===== TTS helper with dedupe using 'announced' Set (in-memory only) ===== */
function speakTextOnce(key, text){
  // if already announced for this session — skip
  if(announced.has(key)) return;
  announced.add(key);
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'ru-RU';
    // beep then speak
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = 'sine';
      o.frequency.value = 880;
      g.gain.value = 0.05;
      o.connect(g); g.connect(ctx.destination);
      o.start();
      setTimeout(()=> { o.stop(); ctx.close(); speechSynthesis.speak(u); }, 160);
    }catch(_){
      speechSynthesis.speak(u);
    }
  }catch(e){ console.warn('TTS fail', e); }
}

/* ===== Firebase listeners (shared) ===== */
ordersRef.on('child_added', snap=>{
  const key = snap.key;
  const val = snap.val();
  orders.set(key, val);

  // if current role is cashier & it's a waiting cash order from bound terminal -> show / auto open
  if(currentRole === 'cashier' && val.paymentType === 'cash' && val.status === 'waiting_for_cash' && boundTerminals.includes(val.terminalId)){
    populateCashOrders();
    if(autoOpenModal) openOrderModal(key, val);
  }

  // if kitchen currently displayed -> refresh
  if(currentRole === 'kitchen') populateKitchenMinimal();
});

ordersRef.on('child_changed', snap=>{
  const key = snap.key;
  const val = snap.val();
  const prev = orders.get(key);
  orders.set(key, val);

  const becameReady = prev && (prev.status !== 'ready') && (val.status === 'ready');

  if(becameReady){
    // ensure timeReady exists
    if(!val.timeReady){
      ordersRef.child(key).update({ timeReady: Date.now() }).catch(()=>{});
      val.timeReady = Date.now();
      orders.set(key,val);
    }
    // speak but only once per session (in-memory)
    if(boundTerminals.includes(val.terminalId)){
      speakTextOnce(key, `Заказ номер ${val.orderNumber} готов`);
    }
  }

  // if status went to canceled remove from local view where appropriate
  if(val.status === 'canceled' || val.status === 'rejected'){
    // nothing special - UI will filter
  }

  // refresh UIs
  if(currentRole === 'cashier') populateCashOrders();
  if(currentRole === 'kitchen') populateKitchenMinimal();
});

ordersRef.on('child_removed', snap=>{
  const key = snap.key;
  if(orders.has(key)) orders.delete(key);
  if(currentRole === 'cashier') populateCashOrders();
  if(currentRole === 'kitchen') populateKitchenMinimal();
});

/* ===== initial load: fetch once so reload persists view ===== */
(async function initLoad(){
  try {
    const snapshot = await ordersRef.once('value');
    snapshot.forEach(child=>{
      orders.set(child.key, child.val());
    });
    renderBoundList();
    refreshMain();
  } catch(e){
    console.error('Init load failed', e);
  }
})();

/* expose debug helpers */
window._fairpoint = {
  getBound: ()=> boundTerminals.slice(),
  setBound: arr => { boundTerminals = arr; localStorage.setItem('boundTerminals', JSON.stringify(boundTerminals)); renderTermList(); renderBoundList(); refreshMain(); },
  getOrdersMap: ()=> Array.from(orders.entries()),
  speakOnce: speakTextOnce
};
</script>
</body>
</html>
