<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>FireKiosk — Показ заказов</title>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<style>
html,body{
  margin:0;
  height:100%;
  background:#0e0e0e;
  color:#fff;
  font-family:Inter,system-ui;
}

.app{
  height:100%;
  display:flex;
  flex-direction:column;
}

header{
  display:flex;
  align-items:center;
  gap:14px;
  padding:16px 24px;
  border-bottom:1px solid #222;
}

#logo{
  width:48px;
  height:48px;
  cursor:pointer;
}

.board{
  flex:1;
  display:grid;
  grid-template-columns:1fr 1fr;
}

.column{
  display:flex;
  flex-direction:column;
}

.column-header{
  text-align:center;
  padding:14px;
  font-weight:800;
  font-size:18px;
}

.cooking .column-header{ background:#c62828 }
.ready .column-header{ background:#2e7d32 }

.list{
  flex:1;
  padding:20px;
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
  gap:16px;
}

.order{
  background:#151515;
  border-radius:18px;
  height:120px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:36px;
  font-weight:900;
  letter-spacing:3px;
}

/* STAFF MENU */
#staffMenu{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;
}

#staffBox{
  background:#111;
  padding:20px;
  width:320px;
  border-radius:16px;
}

#staffBox h3{ margin-top:0 }

#staffBox input, #staffBox button{
  width:100%;
  padding:10px;
  margin-bottom:10px;
  border-radius:8px;
  border:none;
}

#staffBox button{
  background:#333;
  color:#fff;
  cursor:pointer;
}

#terminalList div{
  display:flex;
  justify-content:space-between;
  margin-bottom:6px;
}
</style>
</head>

<body>
<div class="app">

<header>
  <div id="logo">
    <!-- SVG ЛОГО -->
  </div>
  <div style="font-size:20px;font-weight:800">FireKiosk — показ заказов</div>
</header>

<div class="board">
  <div class="column cooking">
    <div class="column-header">Готовится</div>
    <div class="list" id="listCooking"></div>
  </div>
  <div class="column ready">
    <div class="column-header">Готово</div>
    <div class="list" id="listReady"></div>
  </div>
</div>

</div>

<!-- STAFF -->
<div id="staffMenu">
  <div id="staffBox">
    <h3>Привязка терминалов</h3>
    <input id="terminalInput" placeholder="ID терминала">
    <button id="addTerminal">Добавить</button>
    <button id="resetTerminals">Reset</button>
    <div id="terminalList"></div>
    <button id="closeStaff">Закрыть</button>
  </div>
</div>

<script>
/* ================= STATE ================= */
const listCooking = document.getElementById('listCooking');
const listReady   = document.getElementById('listReady');

let orders = new Map();
let timers = new Map();
let terminals = JSON.parse(localStorage.getItem('terminals') || '[]');

/* ================= STAFF MENU ================= */
const logo = document.getElementById('logo');
const staffMenu = document.getElementById('staffMenu');
const terminalInput = document.getElementById('terminalInput');
const addTerminal = document.getElementById('addTerminal');
const resetBtn = document.getElementById('resetTerminals');
const terminalList = document.getElementById('terminalList');
const closeStaff = document.getElementById('closeStaff');

let clicks = 0;
logo.addEventListener('click', ()=>{
  clicks++;
  setTimeout(()=>clicks=0,400);
  if(clicks === 3){
    staffMenu.style.display = 'flex';
    renderTerminals();
    clicks = 0;
  }
});

closeStaff.onclick = ()=>{
  staffMenu.style.display = 'none';
};

addTerminal.onclick = ()=>{
  const id = terminalInput.value.trim();
  if(!id) return;
  if(!terminals.includes(id)){
    terminals.push(id);
    localStorage.setItem('terminals', JSON.stringify(terminals));
    terminalInput.value='';
    renderTerminals();
    refresh();
  }
};

resetBtn.onclick = ()=>{
  terminals = [];
  localStorage.removeItem('terminals');
  renderTerminals();
  refresh();
};

/* ================= UI ================= */
function renderTerminals(){
  terminalList.innerHTML='';
  terminals.forEach(t=>{
    const row=document.createElement('div');
    row.textContent=t;
    const del=document.createElement('button');
    del.textContent='×';
    del.onclick=()=>{
      terminals=terminals.filter(x=>x!==t);
      localStorage.setItem('terminals',JSON.stringify(terminals));
      renderTerminals();
      refresh();
    };
    row.appendChild(del);
    terminalList.appendChild(row);
  });
}

function renderOrder(num){
  const d=document.createElement('div');
  d.className='order';
  d.textContent=num;
  return d;
}

function refresh(){
  listCooking.innerHTML='';
  listReady.innerHTML='';
  if(terminals.length === 0) return;

  for(const [,o] of orders){
    if(!terminals.includes(o.terminalId)) continue;
    if(o.status === 'waiting_for_cash') continue;

    if(o.status === 'cooking'){
      listCooking.appendChild(renderOrder(o.orderNumber));
    }
    if(o.status === 'completed' || o.status === 'ready'){
      listReady.appendChild(renderOrder(o.orderNumber));
    }
  }
}

/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey:"AIzaSyCSw_6Lv22XH-jwK3NN6B6QHH_UCa6Sn1s",
  databaseURL:"https://fairpay-fast-default-rtdb.firebaseio.com",
  projectId:"fairpay-fast"
});

const ref = firebase.database().ref('orders');

ref.on('child_added', s=>{
  orders.set(s.key, s.val());
  refresh();
});
ref.on('child_changed', s=>{
  orders.set(s.key, s.val());
  refresh();
});
ref.on('child_removed', s=>{
  orders.delete(s.key);
  refresh();
});
</script>
</body>
</html>
