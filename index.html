<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kitchen Board — Показ заказов</title>

<!-- Firebase (compat build for simple realtime DB usage) -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<style>
  :root{
    --bg:#f5f5f5;
    --card:#ffffff;
    --muted:#666666;
    --accent:#7B1F24;
    --accent-light:#B94A4F;
    --accent-soft:#9B3A66;
    --ready:#4CAF50;
    --glass: rgba(255,255,255,0.7);
    --shadow: 0 4px 12px rgba(0,0,0,0.15);
    font-family: Inter, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }

  html,body{
    height:100%;
    margin:0;
    background: linear-gradient(180deg, #ffffff 0%, #eeeeee 100%);
    color: #000;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  .container{
    max-width:1200px;
    margin:28px auto;
    padding:20px;
  }

  header{
    display:flex;
    align-items:center;
    gap:16px;
    margin-bottom:18px;
  }

  .logo{
    width:56px;height:56px;border-radius:12px;
    background: linear-gradient(135deg,var(--accent) 0%, var(--accent-soft) 60%);
    display:flex;align-items:center;justify-content:center;font-weight:700;
    font-size:20px; cursor:pointer;
    color:#fff;
  }

  h1{ font-size:20px; margin:0; letter-spacing:0.6px;}
  p.lead{ margin:0;color:var(--muted); font-size:13px }

  .board{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:18px;
    margin-top:18px;
  }

  .column{
    background: var(--card);
    border-radius:14px; padding:14px; box-shadow:var(--shadow);
    min-height:300px;
    border: 1px solid rgba(0,0,0,0.05);
  }

  .col-title{
    display:flex;align-items:center;gap:10px;margin-bottom:12px;
  }
  .col-title h2{ margin:0;font-size:16px; }
  .col-count{
    margin-left:auto; font-weight:700; background:rgba(0,0,0,0.05);
    padding:6px 10px;border-radius:10px;font-size:13px;
  }

  .list { display:flex; flex-direction:column; gap:12px; }

  .card{
    display:flex; gap:12px; align-items:center;
    padding:12px;border-radius:12px;background: var(--card);
    border: 1px solid rgba(0,0,0,0.05);
    transition: transform .18s ease, box-shadow .18s ease, opacity .3s ease;
  }
  .card:hover{ transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.2) }

  .status-dot{ width:12px;height:12px;border-radius:50%;flex:0 0 12px; }
  .dot-cooking{ background: var(--accent); }
  .dot-ready{ background: var(--ready); }

  .card-left{ display:flex; gap:12px; align-items:center; width:100%; }
  .order-number{
    min-width:92px;padding:8px 10px;border-radius:8px;font-weight:700;
    background: rgba(0,0,0,0.03);
    text-align:center; font-size:18px;
  }
  .details{ flex:1; }
  .details .title{ font-size:16px; margin-bottom:6px; }
  .details .meta{ font-size:13px; color:var(--muted); }

  .card-actions{ display:flex; gap:8px; align-items:center; }
  .small-btn{ padding:6px 8px;border-radius:8px;border:0; background:rgba(0,0,0,0.05); color:var(--muted); cursor:pointer }
  .small-btn.strong{ background: var(--accent); color:#fff; font-weight:600 }

  /* ready highlight */
  .card.ready{ border-left:4px solid var(--ready); box-shadow: 0 4px 12px rgba(0,128,0,0.12) }

  /* responsive */
  @media (max-width:900px){
    .board{ grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo" id="logo">KB</div>
      <div>
        <h1>Kitchen Board — Показ заказов</h1>
      </div>
    </header>

    <div class="board">
      <section class="column" id="colCooking">
        <div class="col-title">
          <h2>Готовится</h2>
          <div class="col-count" id="countCooking">0</div>
        </div>
        <div class="list" id="listCooking"></div>
      </section>

      <section class="column" id="colReady">
        <div class="col-title">
          <h2>Готово</h2>
          <div class="col-count" id="countReady">0</div>
        </div>
        <div class="list" id="listReady"></div>
      </section>
    </div>
  </div>

  <!-- Персональное меню -->
  <div id="staffMenu" style="display:none; position:absolute; top:100px; left:50%; transform:translateX(-50%); 
      background:#fff; color:#000; padding:20px; border-radius:12px; z-index:1000; box-shadow:0 4px 16px rgba(0,0,0,0.3);">
    <h3>Персональное меню</h3>
    <p>Привязка терминалов (через запятую):</p>
    <input type="text" id="terminalsInput" placeholder="T-101,T-102" style="width:200px"/>
    <button id="saveTerminals">Сохранить</button>
  </div>

<script>
const AUTO_EXPIRE_MS = 2 * 60 * 1000; // 2 минуты
let firebaseEnabled = true;
let orders = new Map(); // key -> order
let timersExpire = new Map();
let myTerminals = [];

const listCooking = document.getElementById('listCooking');
const listReady = document.getElementById('listReady');
const countCooking = document.getElementById('countCooking');
const countReady = document.getElementById('countReady');

const FIREBASE_CONFIG = {
  apiKey: "AIzaSyCSw_6Lv22XH-jwK3NN6B6QHH_UCa6Sn1s",
  authDomain: "fairpay-fast.firebaseapp.com",
  databaseURL: "https://fairpay-fast-default-rtdb.firebaseio.com",
  projectId: "fairpay-fast",
  storageBucket: "fairpay-fast.firebasestorage.app",
  messagingSenderId: "764987626490",
  appId: "1:764987626490:web:e3451c8162f6992449ca43"
};

let dbRef = null;
if(FIREBASE_CONFIG && typeof FIREBASE_CONFIG === 'object'){
  try{
    firebase.initializeApp(FIREBASE_CONFIG);
    dbRef = firebase.database().ref('orders');
    console.info('Firebase enabled, listening to /orders');
  } catch(e){
    firebaseEnabled = false;
    console.warn('Firebase init failed', e);
  }
}

// --- helpers ---
function el(tag, cls, inner){
  const d = document.createElement(tag);
  if(cls) d.className = cls;
  if(inner!==undefined) d.innerHTML = inner;
  return d;
}

function formatTime(ts){
  return new Date(ts).toLocaleTimeString();
}

function renderOrderCard(key, order){
  const c = el('div','card');
  c.dataset.key = key;
  if(order.status==='completed') c.classList.add('ready');

  const left = el('div','card-left');
  const dot = el('div','status-dot '+(order.status==='completed'?'dot-ready':'dot-cooking'));
  const num = el('div','order-number', `<div style="font-size:12px;color:var(--muted)">#</div>${order.orderNumber || key}`);
  const details = el('div','details');
  const title = el('div','title', `${order.items && order.items.length ? order.items.map(i=>i.name).join(', ') : 'Заказ'}`);
  const meta = el('div','meta', `Терминал: ${order.terminalId||'—'} • ${order.time?formatTime(order.time):''}`);
  details.appendChild(title);
  details.appendChild(meta);
  left.appendChild(dot);
  left.appendChild(num);
  left.appendChild(details);

  const actions = el('div','card-actions');
  if(order.status==='pending'){
    const btnReady = el('button','small-btn strong','Пометить готовым');
    btnReady.addEventListener('click', ()=> markReady(key));
    actions.appendChild(btnReady);
  }

  c.appendChild(left);
  c.appendChild(actions);
  return c;
}

function refreshUI(){
  listCooking.innerHTML='';
  listReady.innerHTML='';
  let cookingCount=0, readyCount=0;
  if(myTerminals.length===0) return;

  for(const [key, order] of orders.entries()){
    if(!myTerminals.includes(order.terminalId)) continue;

    if(order.status==='completed'){
      listReady.appendChild(renderOrderCard(key, order));
      readyCount++;
    } else if(order.status==='pending'){
      listCooking.appendChild(renderOrderCard(key, order));
      cookingCount++;
    }
  }

  countCooking.textContent = cookingCount;
  countReady.textContent = readyCount;
}

function markReady(key){
  const order = orders.get(key);
  if(!order) return;
  if(firebaseEnabled && dbRef){
    dbRef.child(key).update({status:'completed', timeReady:Date.now()}).catch(()=>{});
  } else {
    order.status='completed';
    order.timeReady=Date.now();
    orders.set(key, order);
    onOrderUpdated(key, order);
  }
}

function handleBecameReady(key, order){
  speakText(`Заказ номер ${order.orderNumber || key} готов`);
  clearExpireTimer(key);
  const t = setTimeout(()=>{
    orders.delete(key);
    refreshUI();
  }, AUTO_EXPIRE_MS);
  timersExpire.set(key, t);
}

function clearExpireTimer(key){
  const t = timersExpire.get(key);
  if(t){ clearTimeout(t); timersExpire.delete(key); }
}

function speakText(text){
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.lang='ru-RU';
    speechSynthesis.cancel();
    setTimeout(()=>speechSynthesis.speak(u), 200);
  }catch(e){}
}

// Firebase listeners
if(firebaseEnabled && dbRef){
  dbRef.on('child_added', snapshot=>{
    const key = snapshot.key;
    const val = snapshot.val();
    orders.set(key,val);
    refreshUI();
    if(val.status==='completed') handleBecameReady(key,val);
  });

  dbRef.on('child_changed', snapshot=>{
    const key = snapshot.key;
    const val = snapshot.val();
    const prev = orders.get(key);
    orders.set(key,val);
    refreshUI();
    if(prev?.status!=='completed' && val.status==='completed'){
      handleBecameReady(key,val);
    }
  });

  dbRef.on('child_removed', snapshot=>{
    const key = snapshot.key;
    orders.delete(key);
    clearExpireTimer(key);
    refreshUI();
  });
}

// --- персональное меню ---
let staffClicks=0;
const logo = document.getElementById('logo');
const staffMenu = document.getElementById('staffMenu');
logo.addEventListener('click', ()=>{
  staffClicks++;
  if(staffClicks===3){
    staffMenu.style.display='block';
    staffClicks=0;
  }
});

document.getElementById('saveTerminals').addEventListener('click', ()=>{
  const val = document.getElementById('terminalsInput').value;
  myTerminals = val.split(',').map(s=>s.trim()).filter(s=>s.length>0);
  staffMenu.style.display='none';
  refreshUI();
});

// expose helpers for console
window._kitchen = { orders, markReady, refreshUI };
</script>
</body>
</html>
