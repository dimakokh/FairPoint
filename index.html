<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kitchen Board</title>

<!-- Firebase COMPAT (без module) -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

<style>
:root{
  --bg:#0f0710;
  --card:#1f0b0d;
  --muted:#bfb5b7;
  --accent:#7b1f24;
  --accent-light:#c24b4f;
  --accent-purple:#9b3a66;
}

html,body{
  margin:0;
  height:100%;
  background:linear-gradient(180deg,#0f0710,#14070b);
  color:#fff;
  font-family:Segoe UI,Roboto,Arial;
}

.container{
  max-width:1200px;
  margin:24px auto;
  padding:16px;
}

header{
  display:flex;
  align-items:center;
  gap:16px;
}

.logo{
  width:56px;
  height:56px;
  border-radius:12px;
  background:linear-gradient(135deg,var(--accent),var(--accent-purple));
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  font-size:22px;
}

.board{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:18px;
  margin-top:24px;
}

.column{
  background:rgba(255,255,255,0.03);
  border-radius:14px;
  padding:14px;
}

.col-title{
  display:flex;
  align-items:center;
  margin-bottom:12px;
}

.col-title h2{
  margin:0;
  font-size:18px;
}

.count{
  margin-left:auto;
  background:rgba(255,255,255,0.08);
  padding:6px 10px;
  border-radius:10px;
  font-weight:700;
}

.list{
  display:flex;
  flex-direction:column;
  gap:12px;
}

.card{
  background:linear-gradient(180deg,rgba(0,0,0,.3),rgba(255,255,255,.03));
  border-radius:12px;
  padding:12px;
  display:flex;
  align-items:center;
  gap:12px;
  border-left:4px solid var(--accent);
}

.card.ready{
  border-left-color:var(--accent-light);
}

.order-number{
  font-size:22px;
  font-weight:700;
  min-width:90px;
  text-align:center;
}

.details{
  flex:1;
}

.meta{
  color:var(--muted);
  font-size:13px;
}

button{
  background:linear-gradient(90deg,var(--accent),var(--accent-purple));
  color:#fff;
  border:0;
  padding:8px 10px;
  border-radius:8px;
  cursor:pointer;
}
</style>
</head>

<body>
<div class="container">

<header>
  <div class="logo">KB</div>
  <div>
    <h1>Kitchen Board</h1>
    <div style="color:#bfb5b7;font-size:13px">
      Готовится / Готово
    </div>
  </div>
</header>

<div class="board">
  <div class="column">
    <div class="col-title">
      <h2>Готовится</h2>
      <div class="count" id="countCooking">0</div>
    </div>
    <div class="list" id="listCooking"></div>
  </div>

  <div class="column">
    <div class="col-title">
      <h2>Готово</h2>
      <div class="count" id="countReady">0</div>
    </div>
    <div class="list" id="listReady"></div>
  </div>
</div>

</div>

<script>
/* ================= FIREBASE ================= */

firebase.initializeApp({
  apiKey: "AIzaSyCSw_6Lv22XH-jwK3NN6B6QHH_UCa6Sn1s",
  authDomain: "fairpay-fast.firebaseapp.com",
  databaseURL: "https://fairpay-fast-default-rtdb.firebaseio.com",
  projectId: "fairpay-fast",
  storageBucket: "fairpay-fast.firebasestorage.app",
  messagingSenderId: "764987626490",
  appId: "1:764987626490:web:e3451c8162f6992449ca43"
});

const db = firebase.database();
const ordersRef = db.ref("orders");

/* ================= LOGIC ================= */

const AUTO_REMOVE = 2 * 60 * 1000;
const timers = new Map();

const listCooking = document.getElementById("listCooking");
const listReady = document.getElementById("listReady");
const countCooking = document.getElementById("countCooking");
const countReady = document.getElementById("countReady");

function speak(text){
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "ru-RU";
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

function render(){
  listCooking.innerHTML = "";
  listReady.innerHTML = "";
  let c1 = 0, c2 = 0;

  orders.forEach((o,k)=>{
    const card = document.createElement("div");
    card.className = "card" + (o.status === "ready" ? " ready" : "");

    const num = document.createElement("div");
    num.className = "order-number";
    num.textContent = o.orderNumber || k;

    const det = document.createElement("div");
    det.className = "details";
    det.innerHTML = `<div>${(o.items||[]).map(i=>i.name).join(", ")}</div>
                     <div class="meta">Терминал ${o.terminalId||""}</div>`;

    card.append(num,det);

    if(o.status === "cooking"){
      const btn = document.createElement("button");
      btn.textContent = "Готово";
      btn.onclick = ()=>ordersRef.child(k).update({status:"ready"});
      card.append(btn);
      listCooking.append(card);
      c1++;
    }else{
      listReady.append(card);
      c2++;
    }
  });

  countCooking.textContent = c1;
  countReady.textContent = c2;
}

const orders = new Map();

/* ================= FIREBASE LISTENERS ================= */

ordersRef.on("child_added", s=>{
  orders.set(s.key, s.val());
  render();
});

ordersRef.on("child_changed", s=>{
  const prev = orders.get(s.key);
  const now = s.val();
  orders.set(s.key, now);
  render();

  if(prev?.status !== "ready" && now.status === "ready"){
    speak("Заказ номер " + (now.orderNumber || s.key) + " готов");
    if(timers.has(s.key)) clearTimeout(timers.get(s.key));
    timers.set(s.key,setTimeout(()=>{
      ordersRef.child(s.key).remove();
    },AUTO_REMOVE));
  }
});

ordersRef.on("child_removed", s=>{
  orders.delete(s.key);
  if(timers.has(s.key)) clearTimeout(timers.get(s.key));
  render();
});
</script>

</body>
</html>
